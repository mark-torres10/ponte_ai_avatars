name: CI - Comprehensive

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  frontend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linting
      run: npm run lint
      
    - name: Build frontend
      run: npm run build
      
  backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        cd backend
        npm ci
        
    - name: Run linting
      run: |
        cd backend
        npm run lint
        
    - name: Build backend
      run: |
        cd backend
        npm run build
        
    - name: Run tests
      env:
        NODE_ENV: test
        PORT: 3002
        CORS_ORIGIN: http://localhost:3000
        OPENAI_API_KEY: test-openai-key
        ELEVENLABS_API_KEY: test-elevenlabs-key
        DID_API_KEY: test-did-key
        ELEVENLABS_TERRY_CREWS_VOICE_ID: test-terry-crews-voice-id
        ELEVENLABS_WILL_HOWARD_VOICE_ID: test-will-howard-voice-id
        ELEVENLABS_PARKER_MUNNS_VOICE_ID: test-parker-munns-voice-id
        SUPABASE_URL: https://test.supabase.co
        SUPABASE_ANON_KEY: test-anon-key
        SUPABASE_SERVICE_ROLE_KEY: test-service-role-key
        STORAGE_BUCKET: test-bucket-ponteai
        DEFAULT_REQUESTER_ID: test_user_id
        RATE_LIMIT_WINDOW_MS: 900000
        RATE_LIMIT_MAX_REQUESTS: 100
        LOG_LEVEL: error
      run: |
        cd backend
        npm test
        
  build-verification:
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Verify both builds work together
      run: |
        echo "ðŸ” Verifying frontend build..."
        npm ci
        npm run build
        
        echo "ðŸ” Verifying backend build..."
        cd backend
        npm ci
        npm run build
        
        echo "âœ… All builds completed successfully!"
        echo "âœ… Frontend and backend are compatible"
        
    - name: Create build summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Frontend build: PASSED" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Backend build: PASSED" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Backend tests: PASSED" >> $GITHUB_STEP_SUMMARY
        echo "âœ… TypeScript compilation: PASSED" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All checks completed successfully" >> $GITHUB_STEP_SUMMARY 